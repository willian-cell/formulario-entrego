<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Entregô</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#0066cc;
      --primary-600:#0052a3;
      --primary-300:#4d94ff;
      --accent:#4a90e2;
      --secondary:#00a8ff;
      --text:#343a40;
      --muted:#6c757d;
      --bg:#f5f7fa;
      --card:#ffffff;
      --line:#e1e5eb;
      --line-2:#d0d7e5;
      --light:#e8f1ff;
      --shadow:0 4px 12px rgba(0,0,0,.08);
      --shadow-lg:0 8px 20px rgba(0,0,0,.12);
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:Segoe UI,system-ui,-apple-system,Roboto,Arial,Verdana,sans-serif;line-height:1.6}
    .banner{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:18px 24px;position:relative;overflow:hidden;box-shadow:var(--shadow)}
    .banner h1{display:flex;gap:12px;align-items:center;font-weight:700;font-size:1.6rem}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
    .toolbar .control{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .toolbar input[type="search"]{border:0;outline:0;min-width:220px}
    .toolbar select{border:0;outline:0;background:transparent}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:600;box-shadow:var(--shadow);transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0 28px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;position:relative;overflow:hidden;border-left:4px solid var(--primary)}
    .stat-value{font-size:2rem;font-weight:800;color:var(--primary);margin-bottom:4px}
    .stat-label{color:var(--muted);font-weight:600}
    .table-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1100px;border:1px solid var(--line-2)}
    thead th{position:sticky;top:0;background:var(--primary);color:#fff;font-size:.78rem;text-transform:uppercase;letter-spacing:.3px;padding:10px;border-right:1px solid rgba(255,255,255,.25);cursor:pointer;user-select:none}
    tbody td{padding:9px 10px;border-right:1px solid var(--line);border-top:1px solid var(--line);font-size:.86rem}
    tbody tr:nth-child(even){background:#fafbfc}
    tbody tr:hover{background:var(--light)}
    td.email{word-break:break-word}
    td.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.8rem}
    .thumb{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--line);cursor:pointer}
    .badge{display:inline-block;padding:.18rem .5rem;border-radius:999px;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.3px}
    .badge.moto{background:#e1f5fe;color:#0288d1}
    .badge.bike{background:#e8f5e9;color:#2e7d32}
    @media (max-width:900px){.table-wrap{padding:12px}table{display:none}.cards{display:grid;grid-template-columns:1fr;gap:12px}.card-row{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}.card-row header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.9rem;color:var(--muted)}.meta div{background:#f8fbff;border:1px solid var(--line);border-radius:8px;padding:8px}.meta b{display:block;color:var(--text);margin-bottom:3px}}
  </style>
</head>

<body>
  <!-- Lightbox -->
  <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:9999">
    <span id="lightbox-close" style="position:absolute;top:20px;right:30px;color:#fff;font-size:2rem;cursor:pointer;font-weight:bold">&times;</span>
    <img id="lightbox-img" src="" style="max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.5)">
  </div>

  <header class="banner">
    <h1><i class="fas fa-gauge-high"></i> Dashboard — Entregô Tag Norte</h1>
  </header>

  <main class="container">
    <!-- Toolbar e filtros -->
    <div class="toolbar">
      <div class="control" title="Buscar por Nome, Cidade, CPF, Email">
        <i class="fas fa-magnifying-glass"></i>
        <input id="search" type="search" placeholder="Buscar (nome, cidade, CPF, e-mail…)" />
      </div>
      <div class="control" title="Filtrar por Modal">
        <i class="fas fa-filter"></i>
        <select id="modalFilter">
          <option value="">Todos os modais</option>
          <option value="Moto">Moto</option>
          <option value="Bicicleta">Bicicleta</option>
        </select>
      </div>
      <button id="exportCsv" class="btn"><i class="fas fa-file-arrow-down"></i> Exportar CSV</button>
      <button id="clearFilters" class="btn"><i class="fas fa-eraser"></i> Limpar filtros</button>
    </div>

    <!-- Stats -->
    <section class="stats">
      <div class="card">
        <div class="stat-value" data-counter="{{ total_entregadores }}">{{ total_entregadores }}</div>
        <div class="stat-label">Entregadores cadastrados</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_cidades }}">{{ total_cidades }}</div>
        <div class="stat-label">Cidades distintas</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_modal_moto }}">{{ total_modal_moto }}</div>
        <div class="stat-label">Entregadores de Moto</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_modal_bicicleta }}">{{ total_modal_bicicleta }}</div>
        <div class="stat-label">Entregadores de Bicicleta</div>
      </div>
    </section>

    <!-- Tabela -->
    <section class="table-wrap">
      <h2>Lista de Entregadores</h2>
      <table id="grid">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Email</th>
            <th>Tipo PIX</th>
            <th>Chave PIX</th>
            <th>Validação</th>
            <th>Nacionalidade</th>
            <th>Estado Civil</th>
            <th>CPF</th>
            <th>RG</th>
            <th>Nascimento</th>
            <th>CNPJ</th>
            <th>Cidade</th>
            <th>Modal</th>
            <th>Foto</th>
            <th>CNH</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entregadores %}
          <tr data-modal="{{ e.modal }}">
            <td>{{ e.nome }}</td>
            <td>{{ e.telefone }}</td>
            <td>{{ e.email }}</td>
            <td>{{ e.tipo_chave_pix }}</td>
            <td>{{ e.chave_pix }}</td>
            <td>{{ e.validacao_chave_pix }}</td>
            <td>{{ e.nacionalidade }}</td>
            <td>{{ e.estado_civil }}</td>
            <td>{{ e.cpf }}</td>
            <td>{{ e.rg }}</td>
            <td>{{ e.data_nascimento }}</td>
            <td>{{ e.cnpj if e.cnpj else "Não informado" }}</td>
            <td>{{ e.cidade }}</td>
            <td>{{ e.modal }}</td>
            <td>
              {% if e.foto_rosto %}
                <img src="{{ url_for('uploaded_file', filename=e.foto_rosto) }}" class="thumb" alt="Foto {{ e.nome }}">
              {% else %}
                Sem foto
              {% endif %}
            </td>
            <td>
              {% if e.cnh %}
                <img src="{{ url_for('uploaded_file', filename=e.cnh) }}" class="thumb" alt="CNH {{ e.nome }}">
              {% else %}
                Sem CNH
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // Lightbox
    const imgs = document.querySelectorAll('td img.thumb');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxClose = document.getElementById('lightbox-close');

    imgs.forEach(img=>{
      img.addEventListener('click', ()=>{
        lightbox.style.display='flex';
        lightboxImg.src=img.src;
      });
    });

    lightboxClose.addEventListener('click', ()=>{
      lightbox.style.display='none';
      lightboxImg.src='';
    });

    lightbox.addEventListener('click', e=>{
      if(e.target===lightbox){
        lightbox.style.display='none';
        lightboxImg.src='';
      }
    });

    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        lightbox.style.display='none';
        lightboxImg.src='';
      }
    });

    // Contador animado
    document.querySelectorAll('[data-counter]').forEach(el=>{
      const target=parseInt(el.dataset.counter||el.textContent,10)||0;
      let cur=0; const step=Math.max(1,Math.ceil(target/40));
      const t=setInterval(()=>{
        cur+=step; if(cur>=target){cur=target;clearInterval(t)}
        el.textContent=cur;
      },20);
    });

    // Filtro por texto + modal
    const search=document.getElementById('search');
    const modalFilter=document.getElementById('modalFilter');
    const rows=Array.from(document.querySelectorAll('#grid tbody tr'));

    function matchRow(tr,q,modal){
      const text=tr.innerText.toLowerCase();
      const okText=!q || text.includes(q);
      const okModal=!modal || (tr.dataset.modal||'').toLowerCase()===modal.toLowerCase();
      return okText && okModal;
    }

    function applyFilters(){
      const q=(search.value||'').toLowerCase().trim();
      const m=modalFilter.value;
      rows.forEach(tr=>tr.style.display=matchRow(tr,q,m)?'':'none');
    }

    search.addEventListener('input',applyFilters);
    modalFilter.addEventListener('change',applyFilters);

    document.getElementById('clearFilters').addEventListener('click',()=>{
      search.value=''; modalFilter.value=''; applyFilters();
    });

    // Export CSV
    function toCSV(rows){
      const head=Array.from(document.querySelectorAll('#grid thead th')).map(th=>th.innerText.trim());
      const body=rows.filter(r=>r.style.display!=='none').map(r=>Array.from(r.cells).map(td=>`"${(td.innerText||'').replace(/"/g,'""')}"`).join(','));
      return [head.join(','),...body].join('\n');
    }
    document.getElementById('exportCsv').addEventListener('click',()=>{
      const csv=toCSV(rows);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='entregadores.csv'; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
