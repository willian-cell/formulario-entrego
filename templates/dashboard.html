<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Entregô</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#0066cc;
      --primary-600:#0052a3;
      --primary-300:#4d94ff;
      --accent:#4a90e2;
      --secondary:#00a8ff;
      --text:#343a40;
      --muted:#6c757d;
      --bg:#f5f7fa;
      --card:#ffffff;
      --line:#e1e5eb;
      --line-2:#d0d7e5;
      --light:#e8f1ff;
      --shadow:0 4px 12px rgba(0,0,0,.08);
      --shadow-lg:0 8px 20px rgba(0,0,0,.12);
      --radius:12px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:Segoe UI,system-ui,-apple-system,Roboto,Arial,Verdana,sans-serif;line-height:1.6}

    /* Header */
    .banner{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;padding:18px 24px;position:relative;overflow:hidden;box-shadow:var(--shadow)
    }
    .banner::before{
      content:"";position:absolute;inset:0 0 0 auto;width:180px;background:rgba(255,255,255,.12);
      transform:skewX(-15deg)
    }
    .banner h1{display:flex;gap:12px;align-items:center;font-weight:700;font-size:1.6rem}
    .banner h1 i{font-size:1.3rem}

    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* Toolbar */
    .toolbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px
    }
    .toolbar .control{
      background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)
    }
    .toolbar input[type="search"]{
      border:0;outline:0;min-width:220px
    }
    .toolbar select{border:0;outline:0;background:transparent}
    .btn{
      border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;font-weight:600;box-shadow:var(--shadow);transition:.2s
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0 28px}
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;position:relative;overflow:hidden;border-left:4px solid var(--primary)
    }
    .card::before{content:"";position:absolute;top:0;right:0;width:80px;height:80px;background:var(--light);border-bottom-left-radius:80px}
    .stat-value{font-size:2rem;font-weight:800;color:var(--primary);margin-bottom:4px}
    .stat-label{color:var(--muted);font-weight:600}

    /* Sections (listas) */
    .section{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px
    }
    .section h2{
      font-size:1.1rem;color:var(--primary);display:flex;align-items:center;gap:10px;
      margin-bottom:12px;border-bottom:1px solid var(--line);padding-bottom:10px
    }
    .kv-list{list-style:none;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .kv-item{background:var(--light);border-radius:8px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .kv-item span{background:var(--primary);color:#fff;border-radius:999px;padding:2px 10px;font-size:.8rem}

    /* Table */
    .table-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:auto}
    .table-wrap h2{display:flex;align-items:center;gap:8px;color:var(--primary);margin-bottom:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1100px;border:1px solid var(--line-2)}
    thead th{
      position:sticky;top:0;background:var(--primary);color:#fff;font-size:.78rem;text-transform:uppercase;letter-spacing:.3px;
      padding:10px;border-right:1px solid rgba(255,255,255,.25);cursor:pointer;user-select:none
    }
    thead th:last-child{border-right:0}
    tbody td{padding:9px 10px;border-right:1px solid var(--line);border-top:1px solid var(--line);font-size:.86rem}
    tbody tr:nth-child(even){background:#fafbfc}
    tbody tr:hover{background:var(--light)}
    td.email{word-break:break-word}
    td.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.8rem}
    .thumb{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--line)}
    .badge{display:inline-block;padding:.18rem .5rem;border-radius:999px;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.3px}
    .badge.moto{background:#e1f5fe;color:#0288d1}
    .badge.bike{background:#e8f5e9;color:#2e7d32}

    /* Mobile – cards instead of table */
    @media (max-width: 900px){
      .table-wrap{padding:12px}
      table{display:none}
      .cards{
        display:grid;grid-template-columns:1fr;gap:12px
      }
      .card-row{
        background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)
      }
      .card-row header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
      .meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.9rem;color:var(--muted)}
      .meta div{background:#f8fbff;border:1px solid var(--line);border-radius:8px;padding:8px}
      .meta b{display:block;color:var(--text);margin-bottom:3px}
    }
  </style>
</head>
<body>
  <header class="banner">
    <h1><i class="fas fa-gauge-high"></i> Dashboard — Entregô Tag Norte</h1>
  </header>

  <main class="container">
    <!-- Toolbar -->
    <div class="toolbar" role="region" aria-label="Ferramentas">
      <div class="control" title="Buscar por Nome, Cidade, CPF, Email">
        <i class="fas fa-magnifying-glass"></i>
        <input id="search" type="search" placeholder="Buscar (nome, cidade, CPF, e-mail…)" aria-label="Buscar"/>
      </div>

      <div class="control" title="Filtrar por Modal">
        <i class="fas fa-filter"></i>
        <select id="modalFilter" aria-label="Filtrar por Modal">
          <option value="">Todos os modais</option>
          <option value="Moto">Moto</option>
          <option value="Bicicleta">Bicicleta</option>
        </select>
      </div>

      <button id="exportCsv" class="btn">
        <i class="fas fa-file-arrow-down"></i> Exportar CSV
      </button>

      <button id="clearFilters" class="btn">
        <i class="fas fa-eraser"></i> Limpar filtros
      </button>
    </div>

    <!-- Stats -->
    <section class="stats" aria-label="Resumo">
      <div class="card">
        <div class="stat-value" data-counter="{{ total_entregadores }}">{{ total_entregadores }}</div>
        <div class="stat-label">Entregadores cadastrados</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_cidades }}">{{ total_cidades }}</div>
        <div class="stat-label">Cidades distintas</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_modal_moto }}">{{ total_modal_moto }}</div>
        <div class="stat-label">Entregadores de Moto</div>
      </div>
      <div class="card">
        <div class="stat-value" data-counter="{{ total_modal_bicicleta }}">{{ total_modal_bicicleta }}</div>
        <div class="stat-label">Entregadores de Bicicleta</div>
      </div>
    </section>

    <!-- Lists -->
    <section class="section">
      <h2><i class="fas fa-globe-americas"></i> Análise de Nacionalidade</h2>
      <ul class="kv-list">
        {% for nacionalidade, count in nacionalidades_count.items() %}
        <li class="kv-item">
          {{ nacionalidade }} <span>{{ count }}</span>
        </li>
        {% endfor %}
      </ul>
    </section>

    <section class="section">
      <h2><i class="fas fa-key"></i> Tipos de Chave PIX</h2>
      <ul class="kv-list">
        {% for tipo_chave, count in tipos_chave_pix_count.items() %}
        <li class="kv-item">
          {{ tipo_chave }} <span>{{ count }}</span>
        </li>
        {% endfor %}
      </ul>
    </section>

    <section class="section">
      <h2><i class="fas fa-city"></i> Análise por Cidade</h2>
      <ul class="kv-list">
        {% for cidade, count in cidades_count.items() %}
        <li class="kv-item">
          {{ cidade }} <span>{{ count }}</span>
        </li>
        {% endfor %}
      </ul>
    </section>

    <section class="section">
      <h2><i class="fas fa-heart"></i> Análise de Estado Civil</h2>
      <ul class="kv-list">
        {% for estado_civil, count in estado_civil_count.items() %}
        <li class="kv-item">
          {{ estado_civil }} <span>{{ count }}</span>
        </li>
        {% endfor %}
      </ul>
    </section>

    <!-- Table / Cards -->
    <section class="table-wrap" aria-label="Lista de Entregadores">
      <h2><i class="fas fa-list"></i> Lista de Entregadores</h2>

      <table id="grid">
        <thead>
          <tr>
            <th data-col="nome">Nome Completo</th>
            <th data-col="telefone">Telefone WhatsApp</th>
            <th data-col="email">Email</th>
            <th data-col="tipo_chave_pix">Tipo de Chave PIX</th>
            <th data-col="chave_pix">Chave PIX</th>
            <th data-col="validacao_chave_pix">Validação</th>
            <th data-col="nacionalidade">Nacionalidade</th>
            <th data-col="estado_civil">Estado Civil</th>
            <th data-col="cpf">CPF</th>
            <th data-col="rg">RG</th>
            <th data-col="data_nascimento">Nascimento</th>
            <th data-col="cnpj">CNPJ</th>
            <th data-col="cidade">Cidade</th>
            <th data-col="modal">Modal</th>
            <th data-col="foto">Foto</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entregadores %}
          <tr data-modal="{{ e.modal }}">
            <td>{{ e.nome }}</td>
            <td>{{ e.telefone }}</td>
            <td class="email">{{ e.email }}</td>
            <td>{{ e.tipo_chave_pix }}</td>
            <td class="mono">{{ e.chave_pix }}</td>
            <td>{{ e.validacao_chave_pix }}</td>
            <td>{{ e.nacionalidade }}</td>
            <td>{{ e.estado_civil }}</td>
            <td class="mono">{{ e.cpf }}</td>
            <td class="mono">{{ e.rg }}</td>
            <td>{{ e.data_nascimento }}</td>
            <td>{{ e.cnpj if e.cnpj else "Não informado" }}</td>
            <td>{{ e.cidade }}</td>
            <td>
              {% if e.modal and e.modal.lower() == 'moto' %}
                <span class="badge moto">Moto</span>
              {% else %}
                <span class="badge bike">{{ e.modal }}</span>
              {% endif %}
            </td>
            <td>
              {% if e.foto_rosto %}
                <img src="{{ url_for('uploaded_file', filename=e.foto_rosto) }}" alt="Foto de {{ e.nome }}" class="thumb">
              {% else %}
                <span style="color:var(--muted)">Sem foto</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Mobile cards -->
      <div class="cards" id="cards" aria-hidden="true">
        {% for e in entregadores %}
        <div class="card-row" data-modal="{{ e.modal }}">
          <header>
            <strong>{{ e.nome }}</strong>
            {% if e.modal and e.modal.lower() == 'moto' %}
              <span class="badge moto">Moto</span>
            {% else %}
              <span class="badge bike">{{ e.modal }}</span>
            {% endif %}
          </header>
          <div class="meta">
            <div><b>Telefone</b> {{ e.telefone }}</div>
            <div><b>Email</b> {{ e.email }}</div>
            <div><b>CPF</b> {{ e.cpf }}</div>
            <div><b>RG</b> {{ e.rg }}</div>
            <div><b>Nascimento</b> {{ e.data_nascimento }}</div>
            <div><b>Cidade</b> {{ e.cidade }}</div>
            <div><b>Pix</b> <span style="font-family:ui-monospace">{{ e.chave_pix }}</span></div>
            <div><b>Nacionalidade</b> {{ e.nacionalidade }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
  </main>

  <script>
    // Contador animado
    document.querySelectorAll('[data-counter]').forEach(el=>{
      const target = parseInt(el.dataset.counter||el.textContent,10)||0;
      let cur = 0; const step = Math.max(1, Math.ceil(target/40));
      const t = setInterval(()=>{
        cur += step; if(cur>=target){cur=target;clearInterval(t)}
        el.textContent = cur;
      },20);
    });

    // Filtro por texto + modal
    const search = document.getElementById('search');
    const modalFilter = document.getElementById('modalFilter');
    const rows = Array.from(document.querySelectorAll('#grid tbody tr'));
    const cards = Array.from(document.querySelectorAll('#cards .card-row'));

    function matchRow(tr, q, modal){
      const text = tr.innerText.toLowerCase();
      const okText = !q || text.includes(q);
      const okModal = !modal || (tr.dataset.modal||'').toLowerCase() === modal.toLowerCase();
      return okText && okModal;
    }
    function applyFilters(){
      const q = (search.value||'').toLowerCase().trim();
      const m = modalFilter.value;
      rows.forEach(tr => tr.style.display = matchRow(tr,q,m)?'':'none');
      cards.forEach(div => {
        const txt = div.innerText.toLowerCase();
        const okText = !q || txt.includes(q);
        const okModal = !m || (div.dataset.modal||'').toLowerCase() === m.toLowerCase();
        div.style.display = (okText && okModal)?'':'none';
      });
    }
    search.addEventListener('input', applyFilters);
    modalFilter.addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=>{
      search.value=''; modalFilter.value=''; applyFilters();
    });

    // Ordenação por coluna (tabela)
    const grid = document.getElementById('grid');
    const ths = grid.querySelectorAll('thead th');
    let sortState = { index:-1, asc:true };

    ths.forEach((th, idx)=>{
      th.addEventListener('click', ()=>{
        const tbody = grid.tBodies[0];
        const arr = Array.from(tbody.rows);
        const asc = sortState.index===idx ? !sortState.asc : true;
        arr.sort((a,b)=>{
          const A = (a.cells[idx].innerText||'').trim().toLowerCase();
          const B = (b.cells[idx].innerText||'').trim().toLowerCase();
          if(!isNaN(A) && !isNaN(B)) return asc ? (A-B) : (B-A);
          return asc ? A.localeCompare(B) : B.localeCompare(A);
        });
        arr.forEach(r=>tbody.appendChild(r));
        sortState = { index:idx, asc };
      });
    });

    // Export CSV (considera linhas filtradas visíveis)
    function toCSV(rows){
      const head = Array.from(grid.tHead.rows[0].cells).map(th => th.innerText.trim());
      const body = rows.filter(r => r.style.display !== 'none').map(r =>
        Array.from(r.cells).map(td => `"${(td.innerText||'').replace(/"/g,'""')}"`).join(',')
      );
      return [head.join(','), ...body].join('\n');
    }
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const csv = toCSV(Array.from(grid.tBodies[0].rows));
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'entregadores.csv'; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
